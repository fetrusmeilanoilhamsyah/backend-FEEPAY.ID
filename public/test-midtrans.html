<!DOCTYPE html>
<html>
<head>
    <title>Test Midtrans FEEPAY.ID</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #00AA13;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background: #009110;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
    
    <!-- Midtrans Snap Script -->
    <script 
        src="https://app.sandbox.midtrans.com/snap/snap.js" 
        data-client-key="Mid-client-IqjA1CPznzb65H-9">
    </script>
</head>
<body>
    <div class="container">
        <h1>üöÄ Test Midtrans Payment</h1>
        <p>Test pembayaran Midtrans untuk FEEPAY.ID</p>
        
        <button id="payButton" onclick="testPayment()">
            Bayar Sekarang (Rp 10.000)
        </button>
        
        <div id="result"></div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000/api';
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = type;
            resultDiv.innerHTML = message;
        }
        
        async function testPayment() {
            const button = document.getElementById('payButton');
            button.disabled = true;
            button.textContent = 'Processing...';
            
            try {
                showResult('‚è≥ Creating order...', 'info');
                
                // STEP 1: Create Order
                console.log('Step 1: Creating order...');
                const orderResponse = await fetch(`${API_URL}/orders/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        sku: 'ax10',
                        target_number: '08123456789',
                        customer_email: 'test@feepay.id'
                    })
                });
                
                const orderData = await orderResponse.json();
                console.log('Order response:', orderData);
                
                if (!orderData.success) {
                    throw new Error(orderData.message || 'Failed to create order');
                }
                
                const orderId = orderData.data.order_id;
                console.log('‚úÖ Order created:', orderId);
                
                showResult(`‚úÖ Order created: ${orderId}<br>‚è≥ Generating payment token...`, 'info');
                
                // STEP 2: Generate Snap Token
                console.log('Step 2: Generating snap token...');
                const snapResponse = await fetch(`${API_URL}/payments/midtrans/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        order_id: orderId
                    })
                });
                
                const snapData = await snapResponse.json();
                console.log('Snap response:', snapData);
                
                if (!snapData.success) {
                    throw new Error(snapData.message || 'Failed to generate snap token');
                }
                
                const snapToken = snapData.data.snap_token;
                const amount = snapData.data.amount;
                console.log('‚úÖ Snap token:', snapToken);
                
                showResult(`‚úÖ Payment token generated!<br>Amount: Rp ${amount.toLocaleString()}<br>Opening Midtrans...`, 'info');
                
                // STEP 3: Open Midtrans Snap
                console.log('Step 3: Opening Midtrans popup...');
                window.snap.pay(snapToken, {
                    onSuccess: function(result) {
                        console.log('‚úÖ Payment success!', result);
                        
                        showResult(
                            `<h3>‚úÖ PAYMENT SUCCESS!</h3>
                            <p><strong>Order ID:</strong> ${result.order_id}</p>
                            <p><strong>Transaction ID:</strong> ${result.transaction_id}</p>
                            <p><strong>Payment Type:</strong> ${result.payment_type}</p>
                            <p>‚è≥ Checking order status...</p>`,
                            'success'
                        );
                        
                        // Check order status after 3 seconds
                        setTimeout(() => checkOrderStatus(orderId), 3000);
                    },
                    
                    onPending: function(result) {
                        console.log('‚è≥ Payment pending', result);
                        
                        showResult(
                            `<h3>‚è≥ PAYMENT PENDING</h3>
                            <p>Please complete your payment</p>
                            <p><strong>Order ID:</strong> ${result.order_id}</p>
                            <p><strong>Payment Type:</strong> ${result.payment_type}</p>`,
                            'info'
                        );
                        
                        button.disabled = false;
                        button.textContent = 'Bayar Sekarang (Rp 10.000)';
                    },
                    
                    onError: function(result) {
                        console.error('‚ùå Payment error', result);
                        
                        showResult(
                            `<h3>‚ùå PAYMENT ERROR</h3>
                            <p>${result.status_message || 'Payment failed'}</p>`,
                            'error'
                        );
                        
                        button.disabled = false;
                        button.textContent = 'Bayar Sekarang (Rp 10.000)';
                    },
                    
                    onClose: function() {
                        console.log('Payment popup closed');
                        button.disabled = false;
                        button.textContent = 'Bayar Sekarang (Rp 10.000)';
                    }
                });
                
            } catch (error) {
                console.error('Error:', error);
                
                showResult(
                    `<h3>‚ùå ERROR</h3>
                    <p>${error.message}</p>
                    <p><small>Check browser console (F12) for details</small></p>`,
                    'error'
                );
                
                button.disabled = false;
                button.textContent = 'Bayar Sekarang (Rp 10.000)';
            }
        }
        
        async function checkOrderStatus(orderId) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}`);
                const data = await response.json();
                
                console.log('Order status:', data);
                
                if (data.success) {
                    const order = data.data;
                    
                    showResult(
                        `<h3>‚úÖ ORDER STATUS</h3>
                        <p><strong>Order ID:</strong> ${order.order_id}</p>
                        <p><strong>Status:</strong> ${order.status}</p>
                        <p><strong>Product:</strong> ${order.product_name}</p>
                        <p><strong>Target:</strong> ${order.target_number}</p>
                        <p><strong>SN:</strong> ${order.sn || 'Processing...'}</p>
                        <p><strong>Midtrans Status:</strong> ${order.midtrans_transaction_status || 'N/A'}</p>`,
                        'success'
                    );
                }
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }
        
        // Check if Midtrans script loaded
        window.addEventListener('load', function() {
            if (typeof window.snap === 'undefined') {
                showResult(
                    '‚ùå ERROR: Midtrans script not loaded. Please check your Client Key!',
                    'error'
                );
                document.getElementById('payButton').disabled = true;
            } else {
                console.log('‚úÖ Midtrans script loaded');
            }
        });
    </script>
</body>
</html>